<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Марина Варфоломеева" />


<title>Методы выявления дифференциально-экспрессируемых пептидов</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="my_styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}

.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/multivar/">Multivar</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="index.html">О курсе</a></li>


        <li class="dropdown">
          <a href="appendix" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Конспект<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
             <li><a href="00_introduction.html">О модуле Анализ протеомных данных</a></li>
             <li><a href="01_introduction_to_r.html">Знакомство с R</a></li>
             <li><a href="02_data_preprocessing.html">Предварительная обработка данных</a></li>
      <li><a href="03_classification.html">Классификация</a></li>
      <li><a href="04_differential_expression_analysis.html">Выявление дифференциально-экспрессируемых белков</a></li>
      <li><a href="protocol.html">Протокол анализа данных</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="appendix" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Полезности<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
             <li><a href="supplement.html">Дополнительные темы</a></li>
             <li><a href="resources.html">Ссылки и ресурсы</a></li>
             <li><a href="coding_practices.html">Правила хорошего кода</a></li>
          </ul>
        </li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Методы выявления дифференциально-экспрессируемых пептидов</h1>
<h4 class="author"><em>Марина Варфоломеева</em></h4>

</div>


<div id="------" class="section level1">
<h1>Тестирование статистических гипотез с фриквентистской точки зрения</h1>
<p>Допустим, мы хотим сравнить уровень экспрессии пептидов у морских гребешков, которых содержали при разной температуре. Исходя из существующих исследований и общих знаний мы предполагаем, что уровень экспрессии некоторых пептидов будет различаться (это то, что мы на самом деле думаем — <strong>исследовательская гипотеза</strong>). Чтобы проверить исследовательскую гипотезу, нужна <strong>нулевая гипотеза</strong>. Обычно нулевые гипотезы постулируют отсутствие каких либо различий. Так и в этом примере, нулевая гипотеза говорит, что уровень экспрессии не будет различаться.</p>
<p>Далее, мы проводим эксперимент, измеряем уровень экспрессии. После этого рассчитываем статистику, которая позволит оценить разницу уровней экспрессии в эксперименте (например, t-критерий). Наблюдаемое в эксперименте значение статистики сравнивают со значением, которое было бы получено, если бы уровни экспрессии не различались (т.е. если нулевая гипотеза верна). Если это значение маловероятно получить, когда уровни экспрессии не различаются, то мы “отвергаем” нулевую гипотезу. В таком случае, мы считаем, что результаты нашего эксперимента говорят в пользу нашей исследовательской гипотезы.</p>
<p>При тестировании статистических гипотез возможно четыре варианта развития событий: мы можем принять верное решение (отвергнуть неправильную или принять верную <span class="math inline">\(H_0\)</span>), или мы можем ошибиться — тоже двумя разными способами. В таблице ниже показаны типы ошибок при проверке гипотез.</p>
<table style="width:33%;">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="center"></th>
<th align="center"><span class="math inline">\(H_0\)</span> == TRUE</th>
<th align="center"><span class="math inline">\(H_0\)</span> == FALSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Отклоняем <span class="math inline">\(H_0\)</span></td>
<td align="center">Ошибка <strong>I</strong> рода </br>Ложно-положительный результат</td>
<td align="center">Правильно </br>Положительный результат</td>
</tr>
<tr class="even">
<td align="center">Сохраняем <span class="math inline">\(H_0\)</span></td>
<td align="center">Правильно </br>Отрицательный результат</td>
<td align="center">Ошибка <strong>II</strong> рода </br> Ложно-отрицательный результат</td>
</tr>
</tbody>
</table>
<pre><code>## Warning: Ignoring unknown aesthetics: fill

## Warning: Ignoring unknown aesthetics: fill</code></pre>
<p><img src="04_differential_expression_analysis_files/figure-html/power_beta-1.png" width="384" /></p>
<p><strong>Ошибки I рода</strong> возникают тогда, когда мы ошибочно отклоняем справедливую <span class="math inline">\(H_0\)</span>, т.е. находим различия там, где их нет на самом деле. Находить различия там, где их нет — значит множить сущности сверх необходимого. Поэтому вероятность ошибок I рода ученые договорились строго контролировать и следить, чтобы они появлялись не чаще, чем в 5% случаев. Иногда этот произвольно выбранный порог делают еще жестче — 1%. Вероятность ошибок I рода принято обозначать <span class="math inline">\(\alpha\)</span>. Это тот самый уровень значимости, с которым принято сравнивать доверительные вероятности (p-values), полученные в статистических тестах.</p>
<p><strong>Ошибки II рода</strong> возникают, когда мы ошибочно принимаем ложную <span class="math inline">\(H_0\)</span>, т.е. не находим различий, там, где они на самом деле есть. Несмотря на то, что про ошибки II рода реже вспоминают, их не менее обидно делать. Считается допустимым, если такие ошибки возникают не чаще чем в 20% случаев. Это тоже совершенно произвольно взятый порог. Вероятность ошибок II рода принято обозначать <span class="math inline">\(\beta\)</span>.</p>
<p><strong>Мощность теста</strong> — это способность выявлять различия, когда они есть на самом деле. Зная <span class="math inline">\(\beta\)</span> можно вычислить вероятность того, что статистический тест обнаружит различия <span class="math inline">\(Power = 1 - \beta\)</span></p>
<pre><code>## Warning: Ignoring unknown aesthetics: fill

## Warning: Ignoring unknown aesthetics: fill</code></pre>
<p><img src="04_differential_expression_analysis_files/figure-html/power-1.png" width="384" /></p>
<p>Мощность любого статистического теста будет больше:</p>
<ul>
<li>если величина эффекта (d, величина выявляемых различий) будет больше</li>
<li>если увеличить объем выборки</li>
<li>если повысить уровень значимости (например, вместо <span class="math inline">\(\alpha = 0.01\)</span>, взять <span class="math inline">\(\alpha = 0.05\)</span>)</li>
</ul>
<p>На примере t-критерия зависимость мощности от этих трех величин будет выглядеть так:</p>
<p><img src="04_differential_expression_analysis_files/figure-html/pwr_vs_n-1.png" width="672" /></p>
</div>
<div id="-----the-good-the-bad-and-the-ugly." class="section level1">
<h1>Способы выявления дифференциально экспрессируемых пептидов (The Good, The Bad, and The Ugly).</h1>
<p>Есть множество способов измерить разницу экспрессии. Вот самые распространенные:</p>
<ul>
<li><strong>fold change</strong> — соотношение уровеней экспрессии. Применяется, если нет повторностей. Грубый метод оценки, т.к. не позволяет оценить статистическую значимость.</li>
<li><strong>t-тест</strong> — при небольших выборках у него малая мощность из-за неточной оценки <span class="math inline">\(\sigma\)</span>.</li>
<li><strong>Модерированный t-тест</strong> (с использованием Empirical Bayes) — более мощный, чем обычный t-критерий. Позволяет точнее оценить <span class="math inline">\(\sigma\)</span> для конкретного пептида, используя информацию о распределении <span class="math inline">\(\sigma\)</span> для всех пептидов.</li>
</ul>
<div id="fold-change-the-ugly" class="section level2">
<h2>Fold change (The Ugly)</h2>
<p><img src="images/the_ugly1.jpg" width=300px></p>
<p><strong>Fold change</strong> (FC) — исторически первый способ оценивать дифференциальную экспрессию. Его придумали в те времена, когда делать повторности было дорого. Договорились, что будем считать, что экспрессия меняется, если ее уровень сильно отличается между группами (в 1.5 или 2 раза).</p>
<p>Нужно оценить, во сколько раз экспрессия в одной группе больше, чем экспрессия в другой группе. FC — это пропорция, дробь, в числителе одна группа, в знаменателе другая.</p>
<p>Не надо усреднять соотношения!</p>
<p>Допустим, мы сравниваем уровень экспрессии до и после какого-то воздействия и у нас есть две повторности:</p>
<table style="width:88%;">
<colgroup>
<col width="27%" />
<col width="22%" />
<col width="22%" />
<col width="15%" />
</colgroup>
<thead>
<tr class="header">
<th align="center"></th>
<th align="right">Повторность 1</th>
<th align="right">Повторность 2</th>
<th align="right">Среднее</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">До воздействия</td>
<td align="right"><span class="math inline">\(A_{1} = 1\)</span></td>
<td align="right"><span class="math inline">\(A_{2} = 10\)</span></td>
<td align="right"><span class="math inline">\(\bar{A} = 5.5\)</span></td>
</tr>
<tr class="even">
<td align="center">После воздействия</td>
<td align="right"><span class="math inline">\(B_{1} = 10\)</span></td>
<td align="right"><span class="math inline">\(B_{2} = 1\)</span></td>
<td align="right"><span class="math inline">\(\bar{B} = 5.5\)</span></td>
</tr>
<tr class="odd">
<td align="center"></td>
<td align="right"><span class="math inline">\(A_{1}/B_{1} = 1/10\)</span></td>
<td align="right"><span class="math inline">\(A_{2}/B_{2} = 10/1\)</span></td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="center">Соотношение экспрессии</td>
<td align="right"><span class="math display">\[\frac {A_{1}/B_{1}} {A_{2}/B_{2}} = \frac {1/10 + 10/1} {2} = 5.05\]</span> (<strong>Неправильно!</strong>)</td>
<td align="right"></td>
<td align="right"><span class="math display">\[\bar{A} / \bar{B} = 5.5/5.5 = 0\]</span> (<strong>Правильно!</strong>)</td>
</tr>
</tbody>
</table>
<p>В первой из повторностей уровень экспрессии cнизился в 10 раз (<span class="math inline">\(1/10\)</span>), а во второй — в 10 раз вырос (<span class="math inline">\(10/1\)</span>).</p>
<p>Если мы опрометчиво усредним эти соотношения <span class="math inline">\((1/10 + 10/1) / 2 = 5.05\)</span>, то получится, что уровень экспрессии в среднем вырос в 5 раз — ерунда.</p>
<p>Правильней было бы посчитать средний уровень экспрессии до (<span class="math inline">\((1 + 10)/2 = 5.5\)</span>) и после (<span class="math inline">\((10 + 1)/2 = 5.5\)</span>) и только потом посчитать их соотношение. Тогда мы получили бы гораздо более логичный результат: на самом деле соотношение уровней эеспрессии не изменилось (<span class="math inline">\(5.5/5.5 = 1\)</span>).</p>
<p>Соотношения сырых данных экспрессии брать неудобно, потому что обычные соотношения распределены несимметрично вокруг 1. Сравните, например соотношения: <span class="math inline">\(1/5 = 0.2\)</span>, <span class="math inline">\(5/5 = 1\)</span> и <span class="math inline">\(5/1 = 5\)</span>.</p>
<p>Гораздо удобнее брать логарифм соотношения, потому что его величина распределена симметрично вокруг нуля (и тогда <span class="math inline">\(log(X) = -1 * log(1/X)\)</span>). Действительно, в нашем примере будет так: <span class="math inline">\(log(1/5) = -1.6\)</span>, <span class="math inline">\(log(5/5) = 0\)</span> и <span class="math inline">\(log(5/1) = 1.6\)</span>.</p>
<p>В симметричености распределения логарифмов соотношений мы можем убедится при помощи простой симуляции.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim_ratios &lt;-<span class="st"> </span>function(n_max){
  <span class="co">#&#39; Функция, которая возвращает соотношение двух </span>
  <span class="co">#&#39; случайных целых положительных чисел,</span>
  <span class="co">#&#39; лежащих в пределах от 0 до nmax</span>
  a &lt;-<span class="st"> </span><span class="kw">sample.int</span>(<span class="dt">n =</span> n_max, <span class="dt">size =</span> <span class="dv">1</span>)
  b &lt;-<span class="st"> </span><span class="kw">sample.int</span>(<span class="dt">n =</span> n_max, <span class="dt">size =</span> <span class="dv">1</span>)
  <span class="kw">return</span>(a/b)
}

<span class="co"># Симулируем 100 000 соотношений</span>
<span class="kw">set.seed</span>(<span class="dv">932847</span>)
simulated_ratios &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dt">n =</span> <span class="dv">100000</span>, <span class="kw">sim_ratios</span>(<span class="dt">n_max =</span> <span class="dv">20000</span>))

<span class="co"># Объединяем в датафрейм сырые соотношения и их логарифмы</span>
dat_ratios &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">ratio =</span> simulated_ratios, 
  <span class="dt">log_ratio =</span> <span class="kw">log2</span>(simulated_ratios))

<span class="co"># рисуем боксплот</span>
<span class="kw">boxplot</span>(dat_ratios, <span class="dt">outline =</span> F)
<span class="kw">abline</span>(<span class="dt">h =</span> <span class="dv">0</span>, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>) <span class="co"># 0</span></code></pre></div>
<p><img src="04_differential_expression_analysis_files/figure-html/unnamed-chunk-31-1.png" width="672" /></p>
<p>Операции с логарифмами:</p>
<ul>
<li><span class="math inline">\(log(1) = 0\)</span></li>
<li><span class="math inline">\(log(ab) = log(a) + log(b)\)</span></li>
<li><span class="math inline">\(log(a/b) = log(a) - log(b)\)</span> - это и есть fold change</li>
</ul>
<p>Обычно, данные логарифмируют при помощи логарифма по основанию 2 — <code>log2()</code>, чтобы облегчить сравнение fold change. Тогда, если экспрессия в 2 раза отличается между образцами, получится, что <span class="math inline">\(log2(2x/x) = log2(2) = 1\)</span>.</p>
<p>Основная проблема использования fold change — этот критерий выбирает гены, у которых самая большая разница экспрессии, но не позволяет проверить статистическую значимость различий. На самом деле, при наличии повторностей можно не использовать fold change, поскольку мы можем оценить статистическую значимость различий уровня экспрессии.</p>
</div>
<div id="t--the-bad" class="section level2">
<h2>t-тест (The Bad)</h2>
<p><img src="images/the_bad1.jpg" width=300px></p>
<p>Чтобы проверить гипотезу <span class="math inline">\(H_{0}: \bar{A} - \bar{B} = 0\)</span>, нужно оценить дисперсию в генеральной совокупности <span class="math inline">\(\sigma\)</span>. После этого можно воспользоваться t-критерий.</p>
<p><strong>t-критерий</strong></p>
<p><span class="math display">\[t = \frac {\bar {A} - \bar {B}} {\sqrt{s^{2}}}\]</span></p>
<p>Обычный t-тест исходит из предположения, что дисперсии в группах одинаковы. Обычно, это предположение нереалистично. Мы будем использовать модификацию t-теста для разных дисперсий в группах — т.наз. t-критерий Велша (Welch’s t-test).</p>
<table style="width:56%;">
<colgroup>
<col width="25%" />
<col width="15%" />
<col width="15%" />
</colgroup>
<thead>
<tr class="header">
<th align="center"></th>
<th align="center">Группа А</th>
<th align="center">Группа B</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Наблюдения</td>
<td align="center"><span class="math display">\[a_1, a_2, ..., a_n\]</span></td>
<td align="center"><span class="math display">\[b_1, b_2, ..., b_m\]</span></td>
</tr>
<tr class="even">
<td align="center">Средние значения</td>
<td align="center"><span class="math display">\[\bar{A} = \frac {\sum{a_i}} {n}\]</span></td>
<td align="center"><span class="math display">\[\bar{B} = \frac {\sum{b_i}} {m}\]</span></td>
</tr>
<tr class="odd">
<td align="center">Дисперсии</td>
<td align="center"><span class="math display">\[s^2_a = \frac {\sum{a_i - \bar{A}}} {n - 1}\]</span></td>
<td align="center"><span class="math display">\[s^b_b = \frac {\sum{b_i - \bar{B}}} {m - 1}\]</span></td>
</tr>
</tbody>
</table>
<p><strong>t-критерий для случая неравных дисперсий</strong> (Welch’s t-test)</p>
<p><span class="math display">\[t = \frac {\bar {A} - \bar {B}} {\sqrt{\frac{s^{2}_{a}}{n} + \frac{s^{2}_{b}}{m}}}\]</span></p>
<ul>
<li>если большой объем выборки, то распределение t-статистики приближается к нормальному</li>
<li>если данные распределены нормально, то при любом объеме выборки t-статистика подчиняется t-распределению</li>
</ul>
<p>Далее при t-тесте следуют действия, обычные при тестировании гипотез:</p>
<ul>
<li>Считаем t-статистику.</li>
<li>Считаем вероятность получить такое значение статистики при условии, что нулевая гипотеза верна (p-value).</li>
<li>Сравниваем вероятность (p-value) с заданным уровнем значимости (<span class="math inline">\(\alpha\)</span>). Если эта вероятность меньше заданного уровня значимости - отвергаем нулевую гипотезу.</li>
</ul>
<div id="t---r" class="section level3">
<h3>t-тест в R</h3>
<p>Открываем данные об экспрессии гребешков</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(limma)
expr &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;data/Prot_Br_H_T.csv&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>, <span class="dt">sep =</span> <span class="st">&quot;;&quot;</span>, <span class="dt">row.names =</span> <span class="dv">1</span>)
fact &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;data/Prot_Br_H_T_factor.csv&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>, <span class="dt">sep =</span> <span class="st">&quot;;&quot;</span>, <span class="dt">row.names =</span> <span class="dv">1</span>)</code></pre></div>
<p>Для сегодняшнего занятия давайте возьмем только гребешков из 10 градусов</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f_subset &lt;-<span class="st"> </span>fact$Oxygen ==<span class="st"> &quot;Normox&quot;</span> &amp;<span class="st"> </span>fact$Temperature !=<span class="st"> &quot;25C&quot;</span>
expr_subset &lt;-<span class="st"> </span>expr[, f_subset]
fact_subset &lt;-<span class="st"> </span><span class="kw">droplevels</span>(fact[f_subset, ])</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># нормализуем и логарифмируем, как на прошлых занятиях</span>
expr_log &lt;-<span class="st"> </span><span class="kw">log2</span>(<span class="kw">normalizeQuantiles</span>(expr_subset))</code></pre></div>
<p>Давайте сравним уровень экспрессии первого пептида между группами при помощи простого t-критерия.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">groups &lt;-<span class="st"> </span>fact_subset$Temperature ==<span class="st"> &quot;10C&quot;</span>
<span class="kw">t.test</span>(<span class="dt">x =</span> expr_log[<span class="dv">1</span>, groups], <span class="dt">y =</span> expr_log[<span class="dv">1</span>, !groups])</code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  expr_log[1, groups] and expr_log[1, !groups]
## t = -2.6261, df = 5.3871, p-value = 0.04349
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -1.2957476 -0.0277352
## sample estimates:
## mean of x mean of y 
##  22.40771  23.06945</code></pre>
<p>Но у нас всего 647 пептидов. Было бы не удобно делать все эти сравнения вручную. Поэтому, давайте научимся добывать из объекта, возвращаемого <code>t.test()</code> значение p-value.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t_result &lt;-<span class="st"> </span><span class="kw">t.test</span>(<span class="dt">x =</span> expr_log[<span class="dv">1</span>, groups], <span class="dt">y =</span> expr_log[<span class="dv">1</span>, !groups])
<span class="kw">str</span>(t_result)</code></pre></div>
<pre><code>## List of 9
##  $ statistic  : Named num -2.63
##   ..- attr(*, &quot;names&quot;)= chr &quot;t&quot;
##  $ parameter  : Named num 5.39
##   ..- attr(*, &quot;names&quot;)= chr &quot;df&quot;
##  $ p.value    : num 0.0435
##  $ conf.int   : atomic [1:2] -1.2957 -0.0277
##   ..- attr(*, &quot;conf.level&quot;)= num 0.95
##  $ estimate   : Named num [1:2] 22.4 23.1
##   ..- attr(*, &quot;names&quot;)= chr [1:2] &quot;mean of x&quot; &quot;mean of y&quot;
##  $ null.value : Named num 0
##   ..- attr(*, &quot;names&quot;)= chr &quot;difference in means&quot;
##  $ alternative: chr &quot;two.sided&quot;
##  $ method     : chr &quot;Welch Two Sample t-test&quot;
##  $ data.name  : chr &quot;expr_log[1, groups] and expr_log[1, !groups]&quot;
##  - attr(*, &quot;class&quot;)= chr &quot;htest&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t_result$p.value</code></pre></div>
<pre><code>## [1] 0.04349157</code></pre>
<p>Теперь мы готовы посчитать t-тест для каждого пептида. Для этого нам понадобится:</p>
<ol style="list-style-type: decimal">
<li>написать функцию, которая считает t-test и добывает p-value</li>
<li>к каждой строке данных применить наш t.test</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 1) пишем функцию, которая считает t-test и добывает p-value</span>
t_p_val &lt;-<span class="st"> </span>function(x, f1, f2) {
  <span class="kw">tryCatch</span>(<span class="kw">t.test</span>(<span class="dt">x =</span> x[f1], <span class="dt">y =</span> x[f2])$p.value,
           <span class="dt">error =</span> function(e) <span class="ot">NA</span>)
}
<span class="co"># тестируем функцию</span>
<span class="kw">t_p_val</span>(expr_log[<span class="dv">1</span>, ], <span class="dt">f1 =</span> groups, <span class="dt">f2 =</span> !groups)</code></pre></div>
<pre><code>## [1] 0.04349157</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 2) к каждой строке данных применяем наш t.test</span>
pvals &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="dt">X =</span> expr_log, 
               <span class="dt">MARGIN =</span> <span class="dv">1</span>, 
               <span class="dt">FUN =</span> t_p_val, 
               <span class="dt">f1 =</span> groups, 
               <span class="dt">f2 =</span> !groups)
<span class="co"># В результате мы получаем список p-values</span>
<span class="kw">head</span>(pvals)</code></pre></div>
<pre><code>##         45         53         27         54         66         75 
## 0.04349157 0.00470728 0.21201371 0.47900953 0.48985426 0.07360361</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(pvals)</code></pre></div>
<pre><code>## [1] &quot;numeric&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Его можно легко превратить в вектор</span>
pvals &lt;-<span class="st"> </span><span class="kw">unlist</span>(pvals)</code></pre></div>
<p>Все готово, мы посчитали p-values для всех пептидов.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(pvals)</code></pre></div>
<pre><code>##         45         53         27         54         66         75 
## 0.04349157 0.00470728 0.21201371 0.47900953 0.48985426 0.07360361</code></pre>
<p>Сколько пептидов, достоверно меняющих экспрессию, мы нашли?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(pvals &lt;=<span class="st"> </span><span class="fl">0.05</span>)</code></pre></div>
<pre><code>## [1] NA</code></pre>
<p>Экспрессия каких пептидов различается?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ids_dif &lt;-<span class="st"> </span><span class="kw">which</span>(pvals &lt;=<span class="st"> </span><span class="fl">0.05</span>)
<span class="kw">rownames</span>(expr_log)[ids_dif]</code></pre></div>
<pre><code>##   [1] &quot;45&quot;   &quot;53&quot;   &quot;102&quot;  &quot;134&quot;  &quot;262&quot;  &quot;261&quot;  &quot;278&quot;  &quot;256&quot;  &quot;268&quot;  &quot;272&quot; 
##  [11] &quot;266&quot;  &quot;292&quot;  &quot;274&quot;  &quot;335&quot;  &quot;294&quot;  &quot;339&quot;  &quot;351&quot;  &quot;440&quot;  &quot;525&quot;  &quot;503&quot; 
##  [21] &quot;533&quot;  &quot;528&quot;  &quot;530&quot;  &quot;529&quot;  &quot;574&quot;  &quot;575&quot;  &quot;551&quot;  &quot;557&quot;  &quot;560&quot;  &quot;582&quot; 
##  [31] &quot;573&quot;  &quot;580&quot;  &quot;587&quot;  &quot;588&quot;  &quot;592&quot;  &quot;604&quot;  &quot;624&quot;  &quot;613&quot;  &quot;623&quot;  &quot;651&quot; 
##  [41] &quot;627&quot;  &quot;631&quot;  &quot;650&quot;  &quot;647&quot;  &quot;646&quot;  &quot;657&quot;  &quot;659&quot;  &quot;661&quot;  &quot;658&quot;  &quot;665&quot; 
##  [51] &quot;667&quot;  &quot;670&quot;  &quot;714&quot;  &quot;699&quot;  &quot;767&quot;  &quot;756&quot;  &quot;801&quot;  &quot;798&quot;  &quot;817&quot;  &quot;814&quot; 
##  [61] &quot;800&quot;  &quot;832&quot;  &quot;831&quot;  &quot;845&quot;  &quot;869&quot;  &quot;878&quot;  &quot;861&quot;  &quot;876&quot;  &quot;879&quot;  &quot;897&quot; 
##  [71] &quot;916&quot;  &quot;913&quot;  &quot;895&quot;  &quot;890&quot;  &quot;914&quot;  &quot;933&quot;  &quot;932&quot;  &quot;939&quot;  &quot;954&quot;  &quot;948&quot; 
##  [81] &quot;946&quot;  &quot;958&quot;  &quot;957&quot;  &quot;998&quot;  &quot;990&quot;  &quot;1022&quot; &quot;1024&quot; &quot;1063&quot; &quot;1055&quot; &quot;1059&quot;
##  [91] &quot;1075&quot; &quot;1081&quot; &quot;1089&quot; &quot;1102&quot; &quot;1109&quot; &quot;1111&quot; &quot;1117&quot; &quot;1143&quot; &quot;1151&quot; &quot;1141&quot;
## [101] &quot;1142&quot; &quot;1170&quot; &quot;1175&quot; &quot;1213&quot; &quot;1232&quot; &quot;1253&quot; &quot;1228&quot; &quot;1260&quot; &quot;1290&quot; &quot;1308&quot;
## [111] &quot;1309&quot; &quot;1298&quot; &quot;1361&quot; &quot;1356&quot; &quot;1343&quot; &quot;1419&quot; &quot;1438&quot; &quot;1452&quot; &quot;1496&quot; &quot;1502&quot;
## [121] &quot;1475&quot; &quot;1483&quot; &quot;1519&quot; &quot;1581&quot; &quot;1624&quot; &quot;1600&quot; &quot;1612&quot; &quot;1633&quot; &quot;1643&quot; &quot;1708&quot;
## [131] &quot;1827&quot; &quot;1806&quot; &quot;1854&quot; &quot;1893&quot; &quot;1941&quot; &quot;2036&quot; &quot;2089&quot; &quot;2126&quot; &quot;2112&quot; &quot;2385&quot;
## [141] &quot;2428&quot; &quot;2565&quot; &quot;2537&quot; &quot;2806&quot; &quot;2813&quot;</code></pre>
<p>Проблема в том, что <strong>это пока еще не правильные p-values!</strong></p>
</div>
</div>
<div id="--t-" class="section level2">
<h2>Проблемы с t-тестом</h2>
<div id="-" class="section level3">
<h3>1.Множественные сравнения</h3>
<p>В результате протеомного исследования обычно получают данные об экспрессии сотен–тысяч пептидов. При анализе дифференциальной экспрессии для каждого пептида нам нужно протестировать нулевую гипотезу <span class="math inline">\(H_0: \bar{A} = \bar{B}\)</span>.</p>
<p>В случае, если у нас всего один пептид — мы делаем всего один статистический тест. В этом единственном тесте мы заранее фиксируем вероятность совершить ошибку I рода на уровне значимости <span class="math inline">\(\alpha = 0.05\)</span> (или <span class="math inline">\(\alpha = 0.01\)</span>).</p>
<p>Но представьте себе, что мы сравниваем уровень экспрессии 1000 пептидов. Даже если на самом деле их экспрессия не различается в двух группах (<span class="math inline">\(H_0\)</span> на самом деле справедлива), мы получим по крайней мере в 50 из этих тестов <span class="math inline">\(p &lt; 0.05\)</span>. Т.е. в 50 из 1000 тестов мы совершим ошибку I рода — найдем различия экспрессии там, где их нет. Это непозволительно большое количество ошибок.</p>
<p>Если вероятность ошибки I рода <span class="math inline">\(\alpha = 0.05\)</span>, тогда</p>
<p>Вероятность не совершить ошибку первого рода <span class="math inline">\(1 - \alpha\)</span>.</p>
<p>Вероятность не совершить ошибку первого рода ни в одном из сравнений <span class="math inline">\((1 - \alpha)^{m}\)</span></p>
<p>Вероятность совершить хотябы одну ошибку первого рода в группе сравнений <span class="math inline">\(1 - (1 - \alpha)^{m}\)</span></p>
<table style="width:76%;">
<colgroup>
<col width="15%" />
<col width="19%" />
<col width="41%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">Если не делать поправок на число сравнений…</th>
<th align="center">1 сравнение</th>
<th align="center">семейство из 1000 сравнений</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Число ошибок I рода на число сравнений<br />Per comparison error rate</td>
<td align="center">0.05</td>
<td align="center">0.05</td>
</tr>
<tr class="even">
<td align="center">Ожидаемое число ошибок <br /> Per family error rate</td>
<td align="center">0.05</td>
<td align="center">0.05 * 1000 = 50</td>
</tr>
<tr class="odd">
<td align="center">Вероятность получить хотябы одну ошибку I рода <br /> Family-wise error rate (FWER)</td>
<td align="center">0.05</td>
<td align="center"><span class="math display">\[1 - (1 - 0.05)^{1000} = 1\]</span></td>
</tr>
</tbody>
</table>
<!-- ### Варианты действий -->
<!-- - Можно внести поправки в p-values, чтобы они отражали действительность. (Много вариантов. От Борферрони до Хольма и Хохберга.) -->
<!-- - false discovery rate correction, FDR (Benjamini–Hochberg procedure,  Benjamini–Hochberg–Yekutieli procedure) -->
<!-- - Эмпирическая баесовская статистика или оценки Штейна (? Stein estimators). False coverage statement rate. -->
<!-- - Можно вообще не тестировать гипотезы, а использовать только разведочный анализ - для генерации гипотез, которые потом планируется проверить. -->
<div id="-------i----." class="section level4">
<h4>Контроль вероятности получить хотя бы одну ошибку I рода в группе сравнений.</h4>
<p><strong>Вероятность получить хотябы одну ошибку I рода в группе сравнений (Family-wise error rate, FWER)</strong> можно зафиксировать на каком-нибудь приемлемом уровне. Примеры таких процедур — поправка Бонферрони и метод Хольма-Бонферрони.</p>
<p><strong>Поправка Бонферрони</strong> — процедура в один шаг. Отклоняем все нулевые гипотезы, для которых <span class="math inline">\(p \le \frac {\alpha} {m}\)</span>. Например, если вам нужно сделать 1000 сравнений, чтобы вероятность совершить ошибку I рода была 0.05, то нужно использовать <span class="math inline">\(p = 0.05/1000 = 0.00005\)</span> для каждого сравнения.</p>
<p><strong>Метод Хольма-Бонферрони</strong> — пошаговая процедура.</p>
<p>Чтобы зафиксировать <span class="math inline">\(FWER \le \alpha\)</span>:</p>
<ul>
<li>Сортируем {p_n} p-values, полученные в тестах, в порядке возрастания</li>
</ul>
<p><span class="math inline">\(p_{1} \le p_{2} \le \cdots \le p_{n - 1} \le p_{n}\)</span></p>
<ul>
<li>Вводим поправку для уровня значимости</li>
</ul>
<p><span class="math inline">\(\hat{p_{j}} = min{\{(n - j + 1) \cdot p_{j}, 1\}}\)</span></p>
<p>В таблице приведены результаты нескольких сравнений. Для каждой из доверительных вероятностей (p-values) мы получили свой порог значимости при помощи поправки Хольма-Бонферрони:</p>
<table>
<thead>
<tr class="header">
<th align="right">Ранг (<span class="math inline">\(j\)</span>)</th>
<th align="right"><span class="math inline">\(\mathbf{p_{j}}\)</span></th>
<th align="right"><span class="math inline">\((n - j + 1)\)</span></th>
<th align="right"><span class="math inline">\(\mathbf{\hat{p_{j}}}\)</span></th>
<th align="left">Отвергаем <span class="math inline">\(H_0\)</span>?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">5</td>
<td align="right">0.015</td>
<td align="right">1</td>
<td align="right">0.015</td>
<td align="left">Да</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">0.010</td>
<td align="right">2</td>
<td align="right">0.020</td>
<td align="left">Да</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">0.035</td>
<td align="right">3</td>
<td align="right">0.105</td>
<td align="left">Нет</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0.040</td>
<td align="right">4</td>
<td align="right">0.160</td>
<td align="left">Нет</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0.046</td>
<td align="right">5</td>
<td align="right">0.230</td>
<td align="left">Нет</td>
</tr>
</tbody>
</table>
<p>Недостаток применения контроля FWER — снижение мощности всех тестов: мы каким либо способом снижаем <span class="math inline">\(\alpha\)</span> для каждого сравнения, в результате возрастает <span class="math inline">\(\beta\)</span>, а значит снижается мощность <span class="math inline">\(1 - \beta\)</span>.</p>
<p>Процедуры контроля FWER неоправданно жесткие. Они контролируют вероятность возникновения <strong>хотябы одной</strong> ошибки первого рода в группе сравнений. <!-- Эти процедуры устроены так, как будто мы проверяем обобщенную нулевую гипотезу --- об отсутствии различий во всех сравнениях. На самом деле, эта гипотеза редко интересна с практической точки зрения. --> Считается, что небольшое число ошибок I рода все же можно допустить (например, при анализе геномных или протеомных данных). Именно поэтому часто указывают не уровни значимости после коррекции на множественные сравнения (p-values), а частоту ложноположительных результатов (частоту возникновения ошибок I рода).</p>
</div>
<div id="---." class="section level4">
<h4>Контроль частоты ложноположительных результатов.</h4>
<p><strong>Частота ложноположительных результатов (false discovery rate, FDR)</strong> — это доля ошибок I рода относительно общего числа отвегнутых <span class="math inline">\(H_0\)</span>. Для</p>
<p>Для контроля FDR используется процедура Беньямини-Хохберга.</p>
<p>Алгоритм процедуры Беньямини-Хохберга</p>
<p>Чтобы зафиксировать <span class="math inline">\(FDR \le \gamma\)</span>:</p>
<ul>
<li>Сортируем {p_n} p-values, полученные в тестах, в порядке возрастания</li>
</ul>
<p><span class="math inline">\(p_{1} \le p_{2} \le \cdots \le p_{n - 1} \le p_{n}\)</span></p>
<ul>
<li>Находим такое значение p-value с наибольшим рангом <span class="math inline">\(j\)</span>, чтобы</li>
</ul>
<p><span class="math inline">\(p_{j} \le \frac{j}{n}\times \gamma\)</span></p>
<ul>
<li>Все тесты с рангами меньше <span class="math inline">\(j\)</span> считаем значимыми</li>
</ul>
<p>Для каждого теста можно вычислить точную ожидаемую долю ложноположительных результатов. <span class="math inline">\(\mathbf{q-value}\)</span> — минимальное значение FDR при котором результат конкретного теста можно считать значимым (Storey 2002, Storey Tibshirani 2003).</p>
<p>Например, для 15 сравнений результаты процедуры Беньямини-Хохберга могут выглядеть так:</p>
<table style="width:100%;">
<colgroup>
<col width="12%" />
<col width="19%" />
<col width="39%" />
<col width="19%" />
<col width="9%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">Ранг (<span class="math inline">\(j\)</span>)</th>
<th align="right"><span class="math inline">\(\mathbf{p_{j}}\)</span></th>
<th align="right"><span class="math inline">\(\mathbf{\frac{j}{n}\times \gamma}\)</span></th>
<th align="left">Отвергаем <span class="math inline">\(H_0\)</span>?</th>
<th align="right">q-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0.0010</td>
<td align="right">0.01</td>
<td align="left">Да</td>
<td align="right">0.0150</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0.0070</td>
<td align="right">0.02</td>
<td align="left">Да</td>
<td align="right">0.0525</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">0.0170</td>
<td align="right">0.03</td>
<td align="left">Да</td>
<td align="right">0.0850</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">0.0230</td>
<td align="right">0.04</td>
<td align="left">Да</td>
<td align="right">0.0862</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">0.0300</td>
<td align="right">0.05</td>
<td align="left">Да</td>
<td align="right">0.0900</td>
</tr>
<tr class="even">
<td align="right">9</td>
<td align="right">0.4861</td>
<td align="right">0.09</td>
<td align="left">Нет</td>
<td align="right">0.8102</td>
</tr>
<tr class="odd">
<td align="right">10</td>
<td align="right">0.6741</td>
<td align="right">0.10</td>
<td align="left">Нет</td>
<td align="right">0.9588</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">0.4113</td>
<td align="right">0.08</td>
<td align="left">Нет</td>
<td align="right">0.7712</td>
</tr>
<tr class="odd">
<td align="right">6</td>
<td align="right">0.3252</td>
<td align="right">0.06</td>
<td align="left">Нет</td>
<td align="right">0.7033</td>
</tr>
<tr class="even">
<td align="right">11</td>
<td align="right">0.8492</td>
<td align="right">0.11</td>
<td align="left">Нет</td>
<td align="right">0.9588</td>
</tr>
<tr class="odd">
<td align="right">12</td>
<td align="right">0.8523</td>
<td align="right">0.12</td>
<td align="left">Нет</td>
<td align="right">0.9588</td>
</tr>
<tr class="even">
<td align="right">13</td>
<td align="right">0.8895</td>
<td align="right">0.13</td>
<td align="left">Нет</td>
<td align="right">0.9588</td>
</tr>
<tr class="odd">
<td align="right">15</td>
<td align="right">0.9588</td>
<td align="right">0.15</td>
<td align="left">Нет</td>
<td align="right">0.9588</td>
</tr>
<tr class="even">
<td align="right">14</td>
<td align="right">0.9578</td>
<td align="right">0.14</td>
<td align="left">Нет</td>
<td align="right">0.9588</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">0.3282</td>
<td align="right">0.07</td>
<td align="left">Нет</td>
<td align="right">0.7033</td>
</tr>
</tbody>
</table>
</div>
<div id="-fwer--fdr--r" class="section level4">
<h4>Контроль FWER и FDR в R</h4>
<p>Поправки к p-values в R можно сделать при помощи функции <code>p.adjust()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p_bonf &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(pvals, <span class="dt">method =</span> <span class="st">&quot;bonferroni&quot;</span>)
<span class="kw">head</span>(p_bonf)</code></pre></div>
<pre><code>## 45 53 27 54 66 75 
##  1  1  1  1  1  1</code></pre>
<p>У скольких пептидов экспрессия достоверно различается после поправки Бонферрони?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(p_bonf &lt;=<span class="st"> </span><span class="fl">0.05</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>Названия пептидов, экспрессия которых достоверно различается после поправки Бонферрони?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(pvals)[p_bonf &lt;=<span class="st"> </span><span class="fl">0.05</span>]</code></pre></div>
<pre><code>## [1] NA    NA    &quot;914&quot;</code></pre>
<p>Аргумент <code>method</code> функции <code>p.adjust()</code> задает тип поправки.</p>
<p>Давайте посчитаем, сколько достоверно различающихся пептидов будет найдено после поправки Хольма</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p_holm &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(pvals, <span class="dt">method =</span> <span class="st">&quot;holm&quot;</span>)
<span class="kw">sum</span>(p_holm &lt;=<span class="st"> </span><span class="fl">0.05</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>и сколько — после применения процедуры Беньямини-Хохберга</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p_bh &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(pvals, <span class="dt">method =</span> <span class="st">&quot;BH&quot;</span>)
<span class="kw">sum</span>(p_bh &lt;=<span class="st"> </span><span class="fl">0.05</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] 1</code></pre>
</div>
</div>
<div id="-t-" class="section level3">
<h3>2.Распределение t-статистики</h3>
<p>t-статистика, вычисленная на реальных данных может быть не t-распределена, из-за этого можно прийти к неправильным выводам.</p>
<p>Возможные решения:</p>
<ul>
<li>использование непараметрических тестов, которые не делают никаких предположений о форме распределения. Недостаток — малая мощность.</li>
<li>использование бутстреп-оценок. Недостаток — нужен большой объем выборок.</li>
</ul>
</div>
<div id="---" class="section level3">
<h3>3.Неточная оценка дисперсии экспрессии</h3>
<p>При рассчете обычного t-критерия для оценки дисперсии экспрессии пептидов используется выборочная оценка дисперсии. Если повторностей мало - оценки дисперсии получаются нестабильными и не точными. t-критерий лучше работает при <strong>большом</strong> числе повторностей, т.к. удается точнее оценить <span class="math inline">\(\sigma\)</span></p>
<p>Есть другие способы оценить дисперсию — можно использовать информацию о других пептидах, чтобы оценить распределение возможных значений дисперсии (модерируемый t-критерий, см. ниже).</p>
</div>
<div id="--" class="section level3">
<h3>4.Разная дисперсия экспрессии</h3>
<p>У разных пептидов может быть разная дисперсия экспрессии.</p>
<!-- График: несколько пептидов, по оси х группы, по оси н уровень экспрессии. То же самое можно в виде боксплота, если много значений (больше 5). Каким различиям средних мы будем больше верить - там гле большая или маленькая дисперсия? -->
<!-- ```{r variability} -->
<!-- ``` -->
<p>Часто оказывается, что большая разница уровней экспрессии наблюдается у пептидов с низким уровнем экспрессии.</p>
<!-- RI-plot - график, где по одной оси (I) --- интенсивность экспрессии, а по другой оси (R) --- логарифм соотношения уровней экспрессии.  -->
<!-- ```{r riplot} -->
<!-- ``` -->
<p>Из-за этой особенности данных простое применение t-критерия может привести к некорректным выводам:</p>
<ul>
<li>Даже ничтожные различия уровня экспрессии могут оказаться достоверными для пептидов с небольшой дисперсией экспрессии (т.к. небольшие стандартные ошибки).</li>
<li>Даже очень сильные различия уровня экспрессии могут оказаться недостоверными для пептидов с большой дисперсией экспрессии (т.к. стандартные ошибки велики).</li>
</ul>
<!-- volcano plot: по оси х разница средних логарифмов экспрессии, по оси y - $-log_{10}p-value$. Граница уровня значимости на лог шкале $-log_{10}0.01 = 2$, все что выше - значимо, все что ниже - нет. Сверху, справа и слева - пептиды, которы достоверно меняют экспрессию в ту и др. сторону больше чем в заданное число раз. Внизу справа и слева - пептиды, которые сильно но недостоверно меняют экспрессию. -->
<!-- ```{r volcano} -->
<!-- ``` -->
<!-- ## Модифицированный t-критерий -->
<!-- Модифицированный t-критерий (Witten, Tibshirani, 2007)  -->
<!-- $t_{mod} = \frac {\bar {A} - \bar {B}}{s + s_o}$, -->
<!-- где $s_o$ - это константа, кот. минимизирует коэф. вариации $t_{mod}$. -->
<!-- $s_o$ выбирается при помощи Significance Analysis of Microarrays (SAM) (Tusher et al., 2001) -->
<!-- Модифицированный t-критерий выбирает гены, у которых одновременно большая разница экспрессии и небольшие SE.  -->
</div>
</div>
<div id="moderated-t-test-the-good" class="section level2">
<h2>Moderated t-test (The Good)</h2>
<p><img src="images/the_good1.jpg" width=300px></p>
<p>Реализован в пакете <code>limma</code> <span class="citation">(Ritchie et al. 2015)</span></p>
<p>“Поправленные” стандартные отклонения (shrunk standard deviations)</p>
<p><span class="math display">\[\tilde{s}^{2}_{i} = \frac {s^{2}_{i} d_{i} + s^{2}_{0} d_{0}} {d_{i} + d_{0}}\]</span></p>
<p>Модерированный t-критерий</p>
<p><span class="math display">\[\tilde{t}_{g} = \frac {\bar{M}_{g}} {\tilde{s}_{g}\sqrt{c_{g}}}\]</span></p>
<p>После его применения не будет случаев, когда t-статистика велика просто потому, что стандартная ошибка оказалась маленькой.</p>
<p>Линейные модели (дисперсионный и регрессионный анализ) можно использовать для тестирования сложных гипотез. Модерированный t-критерий, как и обычный, можно использовать для оценки значимости коэффициентов линейных моделей. Мы найдем дифференциально-экспрессируемые пептиды при помощи линейной модели.</p>
<p>Уравнение линейной регрессии, которое мы будем использовать</p>
<p><span class="math display">\[\hat y _{i} = b _0 + b _1 x _{1i} + \epsilon _{i}\]</span></p>
<p>В нем <span class="math inline">\(\hat y _{i}\)</span> — зависимая переменная, уровень экспрессии, <span class="math inline">\(b _0\)</span> и <span class="math inline">\(b _1\)</span> - коэффициенты, <span class="math inline">\(x _{1i}\)</span> — независимая переменная (предиктор, фактор), описывающая принадлежность гребешка к группе, <span class="math inline">\(\epsilon _{i}\)</span> — остатки от линейной регрессии, <span class="math inline">\(i = 1, 2, \cdots, n\)</span> — значения.</p>
<p>Поскольку мы сравниваем всего два состояния фактора, их можно закодировать при помощи одного единственного предиктора <span class="math inline">\(x _{1i}\)</span>. Этот предиктор будет принимать значение 0 на базовом уровне фактора, и значение 1 на другом уровне. В таком случае, коэффициент <span class="math inline">\(b_0\)</span> будет означать уровень экспрессии на базовом уровне фактора, а коэффициент <span class="math inline">\(b_1\)</span> — разницу уровней экспрессии между двумя уровнями фактора.</p>
<p>Уравнение линейной регрессии можно переписать в виде матриц:</p>
<p><span class="math display">\[\left[\begin{array}{c}
\hat y_1 \\ \hat y_2 \\ \vdots \\ \hat y_n 
\end{array}\right] = 
\left[\begin{array}{cc}
1 &amp; x_{1,1} \\
1 &amp; x_{2,1} \\
\vdots &amp; \vdots \\
1 &amp; x_{n,1} 
\end{array}\right] \cdot
\left[\begin{array}{c}
b _0 \\ b _1
\end{array}\right] +
\left[\begin{array}{c}
\epsilon _1 \\ \epsilon _2 \\ \vdots \\ \epsilon _n
\end{array}\right]
\]</span></p>
<p>Сокращенная форма записи линейной регрессии в матричном виде выглядит так: <span class="math inline">\(\mathbf{\hat y} = \mathbf{X} \mathbf{b} + \mathbf{\epsilon}\)</span>.</p>
<p>Чтобы подобрать в R линейную модель экспрессии при помощи пакета <code>limma</code>, нужно будет создать модельную матрицу <span class="math inline">\(\mathbf{X}\)</span>. Затем при помощи функции <code>lmFit()</code> мы подберем коэффициенты линейной регрессии. Поскольку в этом примере мы сравниваем всего два уровня фактора, чтобы проверить, различается ли экспрессия какого-либо пептида между ними, нужно будет всего лишь проверить значимость второго коэффициента линейной модели <span class="math inline">\(b _1\)</span>. Это мы сделаем как раз при помощи модерированного t-критерия. Кроме того, нам придется сделать поправку на множественные сравнения, поскольку мы по-прежнему тестируем много пептидов сразу. Наконец, мы выберем дифференциально-экспрессируемые пептиды и построим тепловую карту их экспрессии.</p>
<p><strong>Внимание! В <code>limma</code> сложно учесть технические реплики. Их проще усреднить перед анализом.</strong></p>
<div id="moderated-t-test--r" class="section level3">
<h3>Moderated t-test в R</h3>
<div id="---expressionset" class="section level4">
<h4>Загружаем данные, создаем ExpressionSet</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(Biobase)
expr_data &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(expr_log)
pheno_data &lt;-<span class="st"> </span>fact_subset
pheno_metadata &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">labelDescription =</span> <span class="kw">c</span>(<span class="st">&quot;Oxygen concentration&quot;</span>, <span class="st">&quot;Temperature&quot;</span>), 
  <span class="dt">row.names=</span><span class="kw">c</span>(<span class="st">&quot;Oxygen&quot;</span>, <span class="st">&quot;Temperature&quot;</span>))
pheno_data &lt;-<span class="st"> </span><span class="kw">new</span>(<span class="st">&quot;AnnotatedDataFrame&quot;</span>, 
                 <span class="dt">data =</span> pheno_data, 
                 <span class="dt">varMetadata =</span> pheno_metadata)
feature_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Spot =</span> <span class="kw">rownames</span>(expr_log))
<span class="kw">rownames</span>(feature_data) &lt;-<span class="st"> </span><span class="kw">rownames</span>(expr_data)
feature_metadata &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">labelDescription =</span> <span class="kw">c</span>(<span class="st">&quot;Spot number&quot;</span>),
  <span class="dt">row.names =</span> <span class="kw">c</span>(<span class="st">&quot;Spot&quot;</span>))
f_data &lt;-<span class="st"> </span><span class="kw">new</span>(<span class="st">&quot;AnnotatedDataFrame&quot;</span>, 
              <span class="dt">data =</span> feature_data, 
              <span class="dt">varMetadata =</span> feature_metadata)
experiment_data &lt;-
<span class="st">  </span><span class="kw">new</span>(<span class="st">&quot;MIAME&quot;</span>,
      <span class="dt">name=</span><span class="st">&quot;Sebastien Artigaud et al.&quot;</span>,
      <span class="dt">lab=</span><span class="st">&quot;lab&quot;</span>,
      <span class="dt">contact=</span><span class="st">&quot;email@domain.com&quot;</span>,
      <span class="dt">title=</span><span class="st">&quot;Proteomic responses to hypoxia at different temperatures in the great scallop (Pecten maximus).&quot;</span>,
      <span class="dt">abstract=</span><span class="st">&quot;Abstract&quot;</span>,
      <span class="dt">other=</span><span class="kw">list</span>(<span class="dt">notes=</span><span class="st">&quot;partial dataset from Artigaud et al. 2014&quot;</span>))
exp_set &lt;-
<span class="st">  </span><span class="kw">ExpressionSet</span>(<span class="dt">assayData =</span> expr_data,
                <span class="dt">phenoData =</span> pheno_data,
                <span class="dt">featureData =</span> f_data,
                <span class="dt">experimentData =</span> experiment_data)</code></pre></div>
</div>
<div id="-" class="section level4">
<h4>Уровни фактора</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">groups &lt;-<span class="st"> </span><span class="kw">pData</span>(exp_set)$Temperature
<span class="kw">table</span>(groups)</code></pre></div>
<pre><code>## groups
## 10C 18C 
##   5   5</code></pre>
</div>
<div id="--" class="section level4">
<h4>Создаем модельную матрицу</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">X &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(~<span class="st"> </span>groups)
X</code></pre></div>
<pre><code>##    (Intercept) groups18C
## 1            1         0
## 2            1         0
## 3            1         0
## 4            1         0
## 5            1         0
## 6            1         1
## 7            1         1
## 8            1         1
## 9            1         1
## 10           1         1
## attr(,&quot;assign&quot;)
## [1] 0 1
## attr(,&quot;contrasts&quot;)
## attr(,&quot;contrasts&quot;)$groups
## [1] &quot;contr.treatment&quot;</code></pre>
</div>
<div id="----i--" class="section level4">
<h4>Подбираем линейную модель для <em>i</em>-того пептида</h4>
<p><span class="math inline">\(y_{i} = X \cdot \beta_{i}\)</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">lmFit</span>(exp_set, <span class="dt">design =</span> X, <span class="dt">method =</span> <span class="st">&quot;robust&quot;</span>, <span class="dt">maxit =</span> <span class="dv">1000</span>)
<span class="kw">names</span>(fit)</code></pre></div>
<pre><code>##  [1] &quot;coefficients&quot;     &quot;stdev.unscaled&quot;   &quot;sigma&quot;           
##  [4] &quot;df.residual&quot;      &quot;cov.coefficients&quot; &quot;pivot&quot;           
##  [7] &quot;rank&quot;             &quot;genes&quot;            &quot;Amean&quot;           
## [10] &quot;method&quot;           &quot;design&quot;</code></pre>
</div>
<div id="empirical-bayes-statistics" class="section level4">
<h4>Empirical Bayes statistics</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">efit &lt;-<span class="st"> </span><span class="kw">eBayes</span>(fit)
<span class="kw">names</span>(efit)</code></pre></div>
<pre><code>##  [1] &quot;coefficients&quot;     &quot;stdev.unscaled&quot;   &quot;sigma&quot;           
##  [4] &quot;df.residual&quot;      &quot;cov.coefficients&quot; &quot;pivot&quot;           
##  [7] &quot;rank&quot;             &quot;genes&quot;            &quot;Amean&quot;           
## [10] &quot;method&quot;           &quot;design&quot;           &quot;df.prior&quot;        
## [13] &quot;s2.prior&quot;         &quot;var.prior&quot;        &quot;proportion&quot;      
## [16] &quot;s2.post&quot;          &quot;t&quot;                &quot;df.total&quot;        
## [19] &quot;p.value&quot;          &quot;lods&quot;             &quot;F&quot;               
## [22] &quot;F.p.value&quot;</code></pre>
</div>
<div id="---" class="section level4">
<h4>Таблица дифференциально-экспрессируемых пептидов</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">topTable</span>(efit, <span class="dt">coef =</span> <span class="dv">2</span>)</code></pre></div>
<pre><code>##      Spot     logFC  AveExpr          t      P.Value    adj.P.Val        B
## 1117 1117 -2.097332 19.60931 -12.233946 1.783848e-07 0.0001154150 7.796468
## 503   503  1.671683 19.26549  10.348757 8.905205e-07 0.0002880834 6.306577
## 1600 1600 -1.552564 19.93536  -9.131667 2.882910e-06 0.0006217477 5.160197
## 339   339 -1.618457 22.95344  -7.924962 1.052596e-05 0.0017025735 3.858720
## 1143 1143 -1.417364 21.62740  -7.470884 1.781123e-05 0.0023047734 3.342798
## 1232 1232 -1.126479 21.28169  -7.296731 2.192627e-05 0.0023643823 3.176141
## 272   272 -1.329412 20.74838  -7.148177 2.625276e-05 0.0024265048 2.940630
## 2112 2112 -1.632038 20.24126  -6.632898 5.005119e-05 0.0035981246 2.295313
## 665   665  2.094273 19.88046   6.643953 4.934600e-05 0.0035981246 2.261852
## 2806 2806 -2.703463 22.75115  -6.514730 5.830548e-05 0.0037723645 2.116281</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">numGenes &lt;-<span class="st"> </span><span class="kw">nrow</span>(<span class="kw">exprs</span>(exp_set))
full_list &lt;-<span class="st"> </span><span class="kw">topTable</span>(efit, <span class="dt">number =</span> numGenes)</code></pre></div>
<pre><code>## Removing intercept from test coefficients</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># View(full_list)</span></code></pre></div>
</div>
<div id="ri-plot" class="section level4">
<h4>RI-plot</h4>
<p>Давайте создадим функцию, которая будет рисовать RI-plot, используя объект, возвращенный <code>eBayes()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">RIP_limma &lt;-<span class="st"> </span>function(efit, coef, <span class="dt">n =</span> <span class="dv">10</span>, <span class="dt">signif =</span> <span class="ot">TRUE</span>, <span class="dt">fdr =</span> <span class="fl">0.05</span>, <span class="dt">lfc =</span> <span class="dv">0</span>, <span class="dt">text =</span> <span class="ot">TRUE</span>, <span class="dt">cex.text =</span> <span class="fl">0.8</span>, <span class="dt">col.text =</span> <span class="st">&quot;grey20&quot;</span>, <span class="dt">main =</span> <span class="st">&quot;RI-plot&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Intensity&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Ratio&quot;</span>, <span class="dt">pch =</span> <span class="dv">19</span>, <span class="dt">pch.signif =</span> <span class="dv">21</span>, <span class="dt">col =</span> <span class="st">&quot;darkgreen&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">cex =</span> <span class="fl">0.3</span>, ...){
  <span class="co"># соотношение и интенсивность</span>
  R &lt;-<span class="st"> </span>efit$coefficients[, coef]
  I &lt;-<span class="st"> </span>efit$Amean
  <span class="co"># прозрачный цвет</span>
  col_btransp &lt;-<span class="st"> </span><span class="kw">adjustcolor</span>(col, <span class="dt">alpha.f =</span> alpha)
  <span class="co"># график</span>
  <span class="kw">plot</span>(I, R, <span class="dt">cex =</span> cex, <span class="dt">main =</span> main, <span class="dt">pch =</span> pch, <span class="dt">xlab =</span> xlab, <span class="dt">ylab =</span> ylab, <span class="dt">col =</span> col_btransp, ...)
  <span class="kw">abline</span>(<span class="dt">h =</span> <span class="dv">0</span>)
  <span class="co"># отмечаем дифференциально-экспрессируемые пептиды</span>
  if(signif){
    sign &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(efit$p.value[, coef], <span class="dt">method =</span> <span class="st">&quot;BH&quot;</span>) &lt;=<span class="st"> </span>fdr
    large &lt;-<span class="st"> </span><span class="kw">abs</span>(efit$coefficients[, coef]) &gt;=<span class="st"> </span>lfc
    <span class="kw">points</span>(I[sign &amp;<span class="st"> </span>large], R[sign &amp;<span class="st"> </span>large], <span class="dt">cex =</span> cex*<span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&quot;orange2&quot;</span>, <span class="dt">pch =</span> pch.signif)
  }
  <span class="co"># подписываем первые n пептидов с сильнее всего различающейся экспрессией</span>
  if(text){
    ord &lt;-<span class="st"> </span><span class="kw">order</span>(efit$lods[, coef], <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)
    top_n &lt;-<span class="st"> </span>ord[<span class="dv">1</span>:n]
    <span class="kw">text</span>(I[top_n], R[top_n], <span class="dt">labels =</span> efit$genes[top_n, ], <span class="dt">pos =</span> <span class="dv">4</span>, <span class="dt">cex =</span> cex.text, <span class="dt">col =</span> col.text)
  }
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">RIP_limma</span>(efit, <span class="dt">coef =</span> <span class="dv">2</span>, <span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">text =</span> F)</code></pre></div>
<p><img src="04_differential_expression_analysis_files/figure-html/unnamed-chunk-55-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">RIP_limma</span>(efit, <span class="dt">coef =</span> <span class="dv">2</span>, <span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">text =</span> F, <span class="dt">lfc =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="04_differential_expression_analysis_files/figure-html/unnamed-chunk-55-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">RIP_limma</span>(efit, <span class="dt">coef =</span> <span class="dv">2</span>, <span class="dt">n =</span> <span class="dv">5</span>)</code></pre></div>
<p><img src="04_differential_expression_analysis_files/figure-html/unnamed-chunk-55-3.png" width="672" /></p>
</div>
<div id="-----" class="section level4">
<h4>Сохраняем список всех пептидов в файл</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dir.create</span>(<span class="st">&quot;results&quot;</span>)</code></pre></div>
<pre><code>## Warning in dir.create(&quot;results&quot;): &#39;results&#39; already exists</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.table</span>(full_list, <span class="dt">file =</span> <span class="st">&quot;results/pecten_diff_expression.csv&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>, <span class="dt">quote =</span> <span class="ot">FALSE</span>, <span class="dt">col.names =</span> <span class="ot">NA</span>)</code></pre></div>
</div>
<div id="------" class="section level4">
<h4>Добываем дифференциально-экспрессируемые пептиды для дальнейшей работы</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f_dif &lt;-<span class="st"> </span>full_list$adj.P.Val &lt;=<span class="st"> </span><span class="fl">0.05</span> &amp;<span class="st"> </span>full_list$logFC &gt;=<span class="st"> </span><span class="dv">1</span>
<span class="co"># Находим имена пятен</span>
names_dif &lt;-<span class="st"> </span>full_list$Spot[f_dif]
<span class="co"># Находим индексы пятен в ExpressionSet</span>
ids_dif_limma &lt;-<span class="st"> </span><span class="kw">match</span>(names_dif, <span class="kw">fData</span>(exp_set)$Spot)
<span class="co"># Фильтруем ExpressionSet</span>
dif_exp_set &lt;-<span class="st"> </span>exp_set[ids_dif_limma, ]

<span class="co"># Короткие имена гребешков</span>
part1 &lt;-<span class="st"> </span><span class="kw">substr</span>(<span class="dt">x =</span> <span class="kw">pData</span>(dif_exp_set)$Oxygen, <span class="dt">start =</span> <span class="dv">0</span>, <span class="dt">stop =</span> <span class="dv">1</span>)
part2 &lt;-<span class="st"> </span><span class="kw">substr</span>(<span class="dt">x =</span> <span class="kw">pData</span>(dif_exp_set)$Temperature, <span class="dt">start =</span> <span class="dv">0</span>, <span class="dt">stop =</span> <span class="dv">2</span>)
short_names &lt;-<span class="st"> </span><span class="kw">make.unique</span>(<span class="kw">paste</span>(part1, part2, <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>))

dat &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">exprs</span>(dif_exp_set))
<span class="kw">colnames</span>(dat) &lt;-<span class="st"> </span>short_names</code></pre></div>
</div>
<div id="----" class="section level4">
<h4>Тепловая карта экспрессии дифференциальных пептидов</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(gplots)

pal_green &lt;-<span class="st"> </span><span class="kw">colorpanel</span>(<span class="dv">75</span>, <span class="dt">low =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">mid =</span> <span class="st">&quot;darkgreen&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;yellow&quot;</span>)
<span class="kw">heatmap.2</span>(dat, <span class="dt">col =</span> pal_green, <span class="dt">scale =</span> <span class="st">&quot;none&quot;</span>, <span class="dt">key=</span><span class="ot">TRUE</span>, <span class="dt">symkey =</span> <span class="ot">FALSE</span>, <span class="dt">density.info =</span> <span class="st">&quot;none&quot;</span>, <span class="dt">trace =</span> <span class="st">&quot;none&quot;</span>, <span class="dt">cexRow =</span> <span class="fl">0.9</span>, <span class="dt">cexCol =</span> <span class="dv">1</span>, <span class="dt">margins =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">3</span>), <span class="dt">keysize =</span> <span class="fl">0.8</span>, <span class="dt">key.par =</span> <span class="kw">list</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="fl">0.1</span>, <span class="dv">3</span>, <span class="fl">0.1</span>)))</code></pre></div>
<p><img src="04_differential_expression_analysis_files/figure-html/unnamed-chunk-58-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pal_blue_red &lt;-<span class="st"> </span><span class="kw">colorpanel</span>(<span class="dv">75</span>, <span class="dt">low =</span> <span class="st">&quot;steelblue&quot;</span>, <span class="dt">mid =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;red&quot;</span>)
<span class="kw">heatmap.2</span>(dat, <span class="dt">col =</span> pal_blue_red, <span class="dt">scale =</span> <span class="st">&quot;row&quot;</span>, <span class="dt">key =</span> <span class="ot">TRUE</span>, <span class="dt">symkey =</span> <span class="ot">FALSE</span>, <span class="dt">density.info =</span> <span class="st">&quot;none&quot;</span>, <span class="dt">trace =</span> <span class="st">&quot;none&quot;</span>, <span class="dt">cexRow =</span> <span class="fl">0.9</span>, <span class="dt">cexCol =</span> <span class="dv">1</span>, <span class="dt">margins =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">3</span>), <span class="dt">keysize =</span> <span class="fl">0.8</span>, <span class="dt">key.par =</span> <span class="kw">list</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="fl">0.1</span>, <span class="dv">3</span>, <span class="fl">0.1</span>)))</code></pre></div>
<p><img src="04_differential_expression_analysis_files/figure-html/unnamed-chunk-59-1.png" width="672" /></p>
<!-- ## `topTreat()` -->
<!-- ```{r} -->
<!-- tfit <- treat(fit, lfc = 1) -->
<!-- topTreat(tfit, coef = 2, number = 20) -->
<!-- ``` -->
<!-- ## Bootstrap -->
<!-- - Нет особенных предположений о форме распределения -->
<!-- - Алгоритм: Считаем t-статистику. Много раз случайным образом переставляем данные между группами и снова считаем t-статистику, чтобы получить ее распределение после случайных перестановок. Считаем уровень значимости t-статистики, как долю пермутаций в которых получилось значение t-статистики больше данного. -->
<!-- - Нужно разумное число повторностей (минимум 4-6), чтобы было что переставлять -->
<!-- ## Дисперсионный анализ (Analysis Of Variance, ANOVA) -->
<!-- - Можно контролировать много факторов сразу -->
<!-- - Нужно неск. повторностей <!-- (я бы сказала, что не меньше 4) -->
<!-- - Должны выполняться условия применимости ANOVA -->
<!-- - Если сравниваемых групп больше двух, то нельзя точно сказать, между  какими группами достоверные различия. После ANOVA нужны пост хок тесты или заранее запланированные сравнения при помощи линейных контрастов.  -->
<!-- ## Адаптивный порог для Fold change -->
<!-- Если при пороге отсечения 2 или 1.5 оказывается выбрано слишком большое число пептидов, можно применять "адаптивный порог" (Fukuoka et al., 2011). Спорный метод - субъективное число групп с разным пороговым уровнем экспрессии.  -->
<!-- Алгоритм: Нужны две технические повторности, чтобы оценить распределение шума. Нормализуем данные. Логарифмируем. Считаем соотношение экспрессий между техническими повторностями. Делим на $i$-групп по значениям нормализованной экспрессии с численностью $N_i$. (Исключаем группы где оказалось меньше 100 генов/пептидов - писали для конференции когда-то). Для каждой группы выбрать случайным образом половину генов в группе и найти для них минимальную и максимальную FC (повторить $N_i/2$ раз). Рассчитать доверительный интервал среднего максимального и минимального FC. CIupper * constant - это верхняя граница достоверности для группы, а CIlower / constant - это нижняя граница достоверности для группы. Если увеличивать constant, то должен снижаться уровень ложноположительных срабатываний. Повторить для других групп. Найденные пороги используются для сравнения тритментов. -->
<!-- Аналогичные методы с разными порогами отсечения: (Tsien et al., 2002b,  Draghici, 2002) -->
<!-- ### Эмпирическая баесовская статистика. -->
<!-- ***** -->
<!-- Применение: смотрим на "типичные" значения стандартных ошибок. Поскольку данные фиксированные и пептидов много, можно оценить как выглядят "типичные" стандартные ошибки у похожих пептидов. -->
</div>
</div>
</div>
<div class="section level2 unnumbered">
<h2>Ссылки</h2>
<div id="refs" class="references">
<div id="ref-Ritchie_2015">
<p>Ritchie, M. E., B. Phipson, D. Wu, Y. Hu, C. W. Law, W. Shi, and G. K. Smyth. 2015. limma powers differential expression analyses for RNA-sequencing and microarray studies. Nucleic Acids Research 43:e47.</p>
</div>
</div>
</div>
</div>

<p><small>
Proteomics course by Marina Varfolomeeva, Arina Maltseva
</small></p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
